<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT-TEC — ABRI 202</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- 
    /**********************************\
    * STYLES.CSS START         *
    \**********************************/
    -->
    <style>
        /* --- VARIABLES DE COULEUR ET THÈMES --- */
        :root {
            --color-green-primary: #00ff41;
            --color-green-dark: #008a23;
            --color-green-bg: rgba(0, 255, 65, 0.05);
            --color-amber-primary: #ffb400;
            --color-amber-dark: #a17200;
            --color-amber-bg: rgba(255, 180, 0, 0.05);
            --color-black: #000;
            --color-dark-grey: #1a1a1a;
            --color-error: #ff0000;

            --primary-color: var(--color-green-primary);
            --dark-color: var(--color-green-dark);
            --bg-color: var(--color-green-bg);
        }

        body.theme-amber {
            --primary-color: var(--color-amber-primary);
            --dark-color: var(--color-amber-dark);
            --bg-color: var(--color-amber-bg);
        }

        /* --- INITIALISATION ET EFFETS GLOBAUX --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            background-color: var(--color-black);
            color: var(--primary-color);
            font-family: 'VT323', monospace;
            font-size: 24px;
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
        }
        
        /* --- EFFETS CRT ET SCANLINES --- */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 4px, 6px 100%;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.5) 50%, transparent 100%);
            background-size: 100% 4px;
            animation: scan 7s linear infinite;
            z-index: 3;
            pointer-events: none;
        }

        /* --- ANIMATIONS --- */
        @keyframes flicker {
            0% { opacity: 0.2; }
            20% { opacity: 0.9; }
            40% { opacity: 0.3; }
            60% { opacity: 1; }
            80% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        @keyframes scan {
            0% { background-position: 0 0; }
            100% { background-position: 0 100vh; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes glitch-transition {
            0% { transform: translate(0); }
            20% { transform: translate(-3px, 3px); text-shadow: 2px 2px var(--color-error); }
            40% { transform: translate(3px, -3px); text-shadow: -2px -2px var(--color-green-dark); }
            60% { transform: translate(-3px, 3px); clip-path: inset(50% 0 50% 0); }
            80% { transform: translate(3px, -3px); clip-path: inset(20% 0 20% 0); }
            100% { transform: translate(0); clip-path: inset(0); }
        }

        /* --- ÉCRAN D'ACCUEIL (OVERLAY) --- */
        #boot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-black);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            transition: opacity 0.5s ease-out;
        }
        
        #boot-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #boot-overlay.glitching, .main-container.glitching {
            animation: glitch-transition 0.6s linear;
        }

        #boot-overlay h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        #boot-overlay button {
            font-size: 1.2rem;
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            background: var(--bg-color);
            color: var(--primary-color);
            cursor: pointer;
            text-shadow: inherit;
            box-shadow: 0 0 10px var(--primary-color) inset;
            transition: background-color 0.3s, color 0.3s;
        }

        #boot-overlay button:hover {
            background: var(--primary-color);
            color: var(--color-black);
        }

        /* --- INTERFACE PRINCIPALE --- */
        .main-container {
            width: 95%;
            height: 95%;
            max-width: 1200px;
            max-height: 800px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color) inset;
            background: rgba(10, 20, 10, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        
        .main-container.visible {
            opacity: 1;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .logo-title {
            display: flex;
            align-items: center;
        }

        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            fill: var(--primary-color);
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        .title h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        .title p {
            font-size: 1rem;
            margin: 0;
        }

        .system-status {
            text-align: right;
        }

        .status-light {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: var(--color-green-primary);
            border-radius: 50%;
            margin-right: 5px;
            box-shadow: 0 0 10px var(--color-green-primary);
            animation: flicker 1s infinite alternate;
        }

        #clock {
            font-size: 1.2rem;
        }

        /* --- THEME SWITCHER --- */
        .theme-switcher {
            display: flex;
            align-items: center;
            margin-top: 5px;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            background-color: var(--dark-color);
            border-radius: 10px;
            border: 1px solid var(--primary-color);
            margin-left: 10px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background-color: var(--primary-color);
            border-radius: 50%;
            transition: .4s;
        }

        body.theme-amber .slider {
            transform: translateX(20px);
        }

        /* --- NAVIGATION --- */
        .nav-bar {
            display: flex;
            justify-content: center;
            padding: 10px 0;
            border-bottom: 2px solid var(--primary-color);
            flex-shrink: 0;
        }

        .nav-bar button {
            font-family: inherit;
            font-size: 1.1rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--primary-color);
            padding: 5px 15px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: inherit;
        }

        .nav-bar button.active, .nav-bar button:hover {
            background: var(--bg-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color) inset;
        }

        @keyframes flashing-yellow {
            0%, 100% {
                background-color: var(--color-amber-bg);
                color: var(--color-amber-primary);
                border-color: var(--color-amber-primary);
                box-shadow: 0 0 8px var(--color-amber-primary) inset;
            }
            50% {
                background-color: var(--color-amber-primary);
                color: var(--color-black);
                border-color: var(--color-amber-primary);
                box-shadow: 0 0 15px var(--color-amber-primary);
            }
        }

        .new-mail-notification {
            animation: flashing-yellow 1s infinite;
        }

        /* --- CONTENT AREA --- */
        .content-area {
            flex-grow: 1;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid var(--dark-color);
            background: var(--bg-color);
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        .content-area::-webkit-scrollbar-track {
            background: var(--color-dark-grey);
        }
        .content-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border: 1px solid var(--dark-color);
        }

        #text-content {
            display: block;
            transition: opacity 0.5s ease-in-out;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 1em;
            background: var(--primary-color);
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }
        
        /* --- FOOTER --- */
        .footer {
            border-top: 2px solid var(--primary-color);
            padding-top: 5px;
            margin-top: 10px;
            text-align: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* --- MODAL DE MOT DE PASSE --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--color-dark-grey);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal.shake {
            animation: shake 0.5s;
        }

        .modal h2 {
            margin-bottom: 20px;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background: var(--bg-color);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: inherit;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .modal input.error {
            border-color: var(--color-error);
            box-shadow: 0 0 10px var(--color-error);
        }

        .modal button {
            font-family: inherit;
            font-size: 1rem;
            padding: 8px 16px;
            margin: 0 5px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
        }

        .modal button:hover {
            background: var(--primary-color);
            color: var(--color-black);
        }

        /* --- NUKA-COLA POPUP --- */
        .nuka-popup {
            background: #a11c1c; /* Nuka-Cola Red */
            border: 3px solid #ffd700; /* Gold/Yellow */
            box-shadow: 0 0 25px #ff4500;
            color: #fff;
            padding: 20px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            font-family: 'VT323', monospace;
            text-shadow: 2px 2px 2px #000;
            border-radius: 10px;
        }

        .nuka-header {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            padding-bottom: 10px;
            border-bottom: 2px dashed #fff;
            margin-bottom: 20px;
        }

        .nuka-trademark {
            font-size: 1.5rem;
            vertical-align: super;
        }

        .nuka-slogan {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 15px;
            animation: flicker 1.5s infinite alternate;
        }

        .nuka-popup button {
            font-family: inherit;
            font-size: 1rem;
            padding: 8px 16px;
            margin-top: 15px;
            background: #ffd700;
            border: 1px solid #fff;
            color: #a11c1c;
            cursor: pointer;
            text-shadow: none;
            border-radius: 5px;
            transition: transform 0.2s;
        }

        .nuka-popup button:hover {
            transform: scale(1.1);
        }

        /* --- BOUTON BIOMÉTRIQUE --- */
        .biometric-button {
            font-family: inherit;
            font-size: 1.2rem;
            padding: 10px 20px;
            margin-top: 20px;
            background: #ff0000;
            border: 2px solid #ff0000;
            color: #fff;
            cursor: pointer;
            text-shadow: 0 0 5px #fff, 0 0 10px #ff0000;
            box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000 inset;
            animation: blink-red 1s infinite step-end;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes blink-red {
            50% {
                background: #a00;
                box-shadow: 0 0 15px #a00, 0 0 20px #a00 inset;
            }
        }

        /* --- MODAL S.P.E.C.I.A.L. --- */
        #special-modal {
            background: var(--color-dark-grey);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color);
            padding: 20px;
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        #special-modal h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px;
        }

        #special-modal p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .character-identity {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .character-identity input {
            width: 50%;
            padding: 8px;
            background: var(--bg-color);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: inherit;
            font-size: 1rem;
        }

        .character-identity input::placeholder,
        .character-password input::placeholder {
            color: var(--dark-color);
        }

        .character-password {
            margin-bottom: 20px;
        }

        .character-password input {
            width: 100%;
            padding: 8px;
            background: var(--bg-color);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: inherit;
            font-size: 1rem;
        }

        .special-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .special-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-basis: 50%;
        }

        .special-description {
            flex-basis: 50%;
            border: 1px solid var(--dark-color);
            padding: 10px;
            background: var(--bg-color);
            text-align: left;
            height: 290px; /* Fixed height */
            overflow-y: auto; /* Add scrollbar if content overflows */
        }

        .special-description h4 {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .special-description p {
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            padding: 5px 10px;
            border: 1px solid var(--dark-color);
        }

        .stat-name {
            font-size: 1.5rem;
        }

        .stat-controls {
            display: flex;
            align-items: center;
        }

        .stat-controls button {
            font-family: inherit;
            font-size: 1.5rem;
            width: 30px;
            height: 30px;
            line-height: 30px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            margin: 0 10px;
        }

        .stat-controls button:hover {
            background: var(--primary-color);
            color: var(--color-black);
        }

        .stat-value {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        #special-confirm-btn, #special-cancel-btn {
            font-family: inherit;
            font-size: 1.2rem;
            padding: 10px 20px;
            background: var(--primary-color);
            border: 1px solid var(--primary-color);
            color: var(--color-black);
            cursor: pointer;
            margin-top: 10px;
            text-shadow: none;
            margin-left: 5px;
            margin-right: 5px;
        }

        #special-cancel-btn {
            background: transparent;
            color: var(--primary-color);
        }

        #special-confirm-btn:hover, #special-cancel-btn:hover {
            background: var(--dark-color);
            color: var(--primary-color);
        }

        /* --- STYLES MODAL CITOYENS --- */
        #citizens-modal {
            max-width: 700px;
        }

        #citizens-list-container {
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--dark-color);
            padding: 10px;
            margin-bottom: 20px;
            background: var(--bg-color);
        }

        .citizen-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--dark-color);
        }

        .citizen-entry:last-child {
            border-bottom: none;
        }

        .citizen-info {
            display: flex;
            flex-direction: column;
        }

        .citizen-name {
            font-size: 1.2rem;
        }

        .citizen-stats {
            font-size: 1.1rem;
            color: var(--primary-color);
            text-shadow: 0 0 3px var(--primary-color);
            margin-top: 5px;
        }

        .delete-citizen-btn {
            background: #ff0000;
            color: #fff;
            border: 1px solid #ff0000;
            padding: 4px 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* --- STYLES MODAL D'ALERTE --- */
        #alert-modal-title.error-title {
            color: var(--color-error);
            text-shadow: 0 0 5px var(--color-error);
        }

        /* --- STYLES MODAL PROMPT --- */
        #prompt-form {
            margin-top: 15px;
        }

    </style>
</head>
<body>

    <div class="scanline"></div>

    <!-- ÉCRAN D'ACCUEIL -->
    <div id="boot-overlay">
        <h1>Vault-Tec CORPORATION</h1>
        <p>Protocole d'initialisation de l'Abri 202 en cours...</p>
        <br>
        <button id="connect-button">Connectez-vous aux services de l'Abri 202</button>
    </div>

    <!-- INTERFACE PRINCIPALE -->
    <div class="main-container" id="main-interface">
        <!-- HEADER -->
        <header class="header">
            <div class="logo-title">
                <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(0 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(30 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(60 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(90 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(120 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(150 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(180 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(210 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(240 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(270 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(300 50 50)"/>
                    <path d="M50,10 L55,25 L70,25 L75,10 Z" transform="rotate(330 50 50)"/>
                    <circle cx="50" cy="50" r="30"/>
                </svg>
                <div class="title">
                    <h1>VAULT-TEC CORPORATION — Abri 202 : L’Arche</h1>
                    <p>"Construire un meilleur demain, aujourd’hui."</p>
                </div>
            </div>
            <div class="system-status">
                <div><span class="status-light"></span> SYSTÈMES NOMINAUX</div>
                <div id="clock"></div>
                <div class="theme-switcher" id="theme-switcher">
                    <span>VERT / AMBRE</span>
                    <div class="switch">
                        <div class="slider"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- BARRE DE NAVIGATION -->
        <nav class="nav-bar" id="nav-bar">
            <button data-tab="citoyens" class="active">Citoyens</button>
            <button data-tab="superviseurH" data-password="choix">Superviseur H</button>
            <button data-tab="superviseurA" data-password="mutation">Superviseur A</button>
            <button data-tab="contexte" data-password="mutation">Contexte</button>
            <button data-tab="mj" data-password="zhaal">MJ</button>
            <button id="mail-btn">Mail</button>
            <button id="registered-citizens-btn">Citoyen enregistré</button>
        </nav>

        <!-- ZONE DE CONTENU -->
        <main class="content-area">
            <div id="text-content"></div><span class="cursor">▮</span>
        </main>

        <!-- PIED DE PAGE -->
        <footer class="footer">
            © Vault-Tec Corporation — Abri 202 — Tous droits réservés.
        </footer>
    </div>

    <!-- MODAL DE MOT DE PASSE -->
    <div class="modal-overlay" id="password-modal-overlay">
        <div class="modal" id="password-modal">
            <h2>ACCÈS RESTREINT</h2>
            <p>Veuillez entrer le mot de passe requis.</p>
            <form id="password-form">
                <input type="password" id="password-input" autocomplete="off">
                <button type="submit">Valider</button>
                <button type="button" id="cancel-button">Annuler</button>
            </form>
        </div>
    </div>

    <!-- NUKA-COLA POP-UP -->
    <div class="modal-overlay" id="nuka-popup-overlay">
        <div class="nuka-popup">
            <div class="nuka-header">
                <span class="nuka-title">NUKA-COLA</span>
                <span class="nuka-trademark">®</span>
            </div>
            <div class="nuka-body">
                <p class="nuka-slogan">BUVEZ DU NUKA-COLA !</p>
                <p>Enjoy a refreshing bottle of Nuka-Cola today!</p>
            </div>
            <button id="nuka-close-btn">Fermer</button>
        </div>
    </div>

    <!-- MODAL S.P.E.C.I.A.L. -->
    <div class="modal-overlay" id="special-modal-overlay">
        <div id="special-modal">
            <h2>S.P.E.C.I.A.L.</h2>
            <p>Créez votre personnage. Vous avez <span id="points-to-spend">21</span> points à répartir.</p>

            <div class="character-identity">
                <input type="text" id="character-lastname" placeholder="Nom..." autocomplete="off">
                <input type="text" id="character-firstname" placeholder="Prénoms..." autocomplete="off">
            </div>
            <div class="character-password">
                <input type="password" id="character-password" placeholder="Mot de passe..." autocomplete="off">
            </div>

            <div class="special-container">
                <div class="special-stats">
                    <!-- Les stats seront générées par JS -->
                </div>
                <div class="special-description" id="special-description-box">
                    <p>Survolez un attribut pour lire sa description.</p>
                </div>
            </div>

            <button id="special-cancel-btn" type="button">Annuler</button>
            <button id="special-confirm-btn">Valider la création</button>
        </div>
    </div>

    <!-- MODAL CITOYENS ENREGISTRÉS -->
    <div class="modal-overlay" id="citizens-modal-overlay">
        <div id="citizens-modal" class="modal">
            <h2>Citoyens Enregistrés</h2>
            <div id="citizens-list-container">
                <!-- La liste des citoyens sera injectée ici par JS -->
                <p>Chargement...</p>
            </div>
            <button id="close-citizens-modal-btn">Fermer</button>
        </div>
    </div>

    <!-- MODAL MAIL -->
    <div class="modal-overlay" id="mail-modal-overlay">
        <div id="mail-modal" class="modal">
            <!-- Contenu dynamique : login ou inbox -->
        </div>
    </div>

    <!-- MODAL D'ALERTE GÉNÉRIQUE -->
    <div class="modal-overlay" id="alert-modal-overlay">
        <div id="alert-modal" class="modal">
            <h2 id="alert-modal-title"></h2>
            <p id="alert-modal-body"></p>
            <button id="alert-modal-close-btn">OK</button>
        </div>
    </div>

    <!-- MODAL DE SAISIE (PROMPT) -->
    <div class="modal-overlay" id="prompt-modal-overlay">
        <div id="prompt-modal" class="modal">
            <h2 id="prompt-modal-title"></h2>
            <p id="prompt-modal-body"></p>
            <form id="prompt-form">
                <input type="password" id="prompt-modal-input" autocomplete="off">
                <button type="submit" id="prompt-modal-ok-btn">OK</button>
                <button type="button" id="prompt-modal-cancel-btn">Annuler</button>
            </form>
        </div>
    </div>

    <!-- EFFETS SONORES -->
    <audio id="audio-connect" src="Connect-pipboy.wav" preload="auto"></audio>
    <audio id="audio-protected" src="accès-protégé.wav" preload="auto"></audio>
    <audio id="audio-amber-on" src="ambre-on.wav" preload="auto"></audio>
    <audio id="audio-amber-off" src="ambre-off.wav" preload="auto"></audio>
    <audio id="audio-mdp-ok" src="mdp-ok.wav" preload="auto"></audio>
    <audio id="audio-mdp-no" src="mdp-no.wav" preload="auto"></audio>
    <audio id="audio-key" src="clavier.wav" preload="auto"></audio>
    <audio id="audio-button" src="bouton.wav" preload="auto"></audio>

    <!--
    /**********************************\
    * APP.JS START            *
    \**********************************/
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SÉLECTION DES ÉLÉMENTS DU DOM ---
            const clockElement = document.getElementById('clock');
            const themeSwitcher = document.getElementById('theme-switcher');
            const navBar = document.getElementById('nav-bar');
            const textContentElement = document.getElementById('text-content');
            const cursorElement = document.querySelector('.cursor');
            
            const bootOverlay = document.getElementById('boot-overlay');
            const connectButton = document.getElementById('connect-button');
            const mainInterface = document.getElementById('main-interface');

            const modalOverlay = document.getElementById('password-modal-overlay');
            const modal = document.getElementById('password-modal');
            const passwordForm = document.getElementById('password-form');
            const passwordInput = document.getElementById('password-input');
            const cancelBtn = document.getElementById('cancel-button');

            const nukaPopupOverlay = document.getElementById('nuka-popup-overlay');
            const nukaCloseBtn = document.getElementById('nuka-close-btn');

            const specialModalOverlay = document.getElementById('special-modal-overlay');
            const specialConfirmBtn = document.getElementById('special-confirm-btn');
            const specialCancelBtn = document.getElementById('special-cancel-btn');
            const specialStatsContainer = document.querySelector('.special-stats');
            const pointsToSpendEl = document.getElementById('points-to-spend');

            const citizensModalOverlay = document.getElementById('citizens-modal-overlay');
            const citizensListContainer = document.getElementById('citizens-list-container');
            const registeredCitizensBtn = document.getElementById('registered-citizens-btn');
            const closeCitizensModalBtn = document.getElementById('close-citizens-modal-btn');

            const mailBtn = document.getElementById('mail-btn');
            const mailModalOverlay = document.getElementById('mail-modal-overlay');
            const mailModal = document.getElementById('mail-modal');

            const alertModalOverlay = document.getElementById('alert-modal-overlay');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalBody = document.getElementById('alert-modal-body');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

            const promptModalOverlay = document.getElementById('prompt-modal-overlay');
            const promptModalTitle = document.getElementById('prompt-modal-title');
            const promptModalBody = document.getElementById('prompt-modal-body');
            const promptForm = document.getElementById('prompt-form');
            const promptModalInput = document.getElementById('prompt-modal-input');
            const promptModalCancelBtn = document.getElementById('prompt-modal-cancel-btn');


            // --- FONCTION SON ---
            function playSound(id) {
                const audio = document.getElementById(id);
                if (audio) {
                    const clone = audio.cloneNode();
                    clone.play();
                }
            }
            document.addEventListener('keydown', () => playSound('audio-key'));

            // --- EFFET GLITCH ---
            function triggerGlitchEffect(element) {
                if (!element) return;
                element.classList.add('glitching');
                setTimeout(() => {
                    element.classList.remove('glitching');
                }, 600); // Durée de l'animation
            }

            // --- CONTENU TEXTUEL DES ONGLETS ---
            const welcomeLetter = `VAULT-TEC CORPORATION
---------------------
Division de l'Abri 202

Lettre de Bienvenue aux Habitants de l'Abri 202

Chers futurs résidents,

Félicitations ! En recevant cette lettre, vous avez été sélectionnés pour faire partie d'une communauté d'exception, l'élite qui reconstruira notre grande nation. L'Abri 202, surnommé "L'Arche", n'est pas un simple refuge, mais le berceau d'un avenir radieux.

Grâce à la technologie de pointe de Vault-Tec, vous vivrez dans un confort et une sécurité inégalés, à l'abri des dangers du monde extérieur. Vos enfants grandiront dans un environnement sain, éduqués par les meilleurs, et préparés à devenir les leaders de demain.

Votre contribution est essentielle. Ensemble, nous allons construire un meilleur lendemain, aujourd'hui.

Cordialement,

Le PDG Vault-Tec`;

            const officialDocument = `============================================================
VAULT-TEC CORPORATION – Service Relations Citoyennes
============================================================
DOCUMENT OFFICIEL – DIFFUSION GÉNÉRALE
------------------------------------------------------------

SUJET : Bienvenue dans L’Arche, Abri 202

Chers résidents,

Bienvenue dans votre nouveau foyer, l’Abri 202 — une merveille d’ingénierie humaine conçue par Vault-Tec pour garantir votre sécurité, votre confort et votre avenir, même face aux défis du monde extérieur.

L’Abri 202 est unique au monde : il abrite deux sections complémentaires destinées à préserver toute la richesse de notre civilisation.

    > Section HABITAT : Votre maison, votre communauté, le lieu où vous vivrez, travaillerez et grandirez.

    > Section ARCHE : Un sanctuaire exceptionnel, pensé pour accueillir humains et animaux dans un environnement harmonieux, fertile et apaisant.

**L’Arche : Un privilège par tirage au sort**

Chaque mois, ou sur décision bienveillante de vos superviseurs, un tirage au sort officiel et équitable désigne un petit nombre de résidents qui auront l’honneur de passer deux jours complets dans l’Arche.

Imaginez :
    - Un paysage verdoyant sur plusieurs hectares, baigné d’une douce lumière artificielle grâce à notre nouvelle 	technologie Vault-Sun+.
    - De l’air purifié, des ruisseaux cristallins, des senteurs naturelles.
    - La compagnie d’animaux dociles et bienveillants.
    - Des repas variés et frais.

Ces séjours sont pensés pour récompenser la discipline, la bonne conduite et l’esprit communautaire. Ils sont aussi l’occasion, pour chacun, de se rappeler ce pour quoi nous travaillons ensemble chaque jour.

**Vos superviseurs : Vos protecteurs**

Votre bien-être et votre avenir sont confiés à deux figures dévouées :

    - Le Superviseur Habitat : Garant de l’ordre, de la sécurité et de la bonne entente. Sa fermeté est le rempart contre le désordre, et son sens du devoir assure à chacun un quotidien sûr et organisé.

    - Le Superviseur Arche : Gardien du sanctuaire et maître des séjours. Il veille à ce que chaque visite soit inoubliable, en harmonie avec la vision de Vault-Tec d’un monde meilleur.

Ces deux leaders travaillent main dans la main, avec un seul objectif : vous offrir un avenir digne des plus grands rêves de l’humanité.

**Notre promesse**

Vault-Tec s’engage à faire de l’Abri 202 non seulement un refuge, mais un tremplin vers demain.
Ici, chacun a sa place, chacun a sa valeur, et chacun a la possibilité, un jour, de découvrir la beauté éternelle de l’Arche.

Ensemble, bâtissons un avenir plus radieux.
Ensemble, gardons l’espoir.
Ensemble, nous sommes L’Arche.

Pour la sécurité, la prospérité et l’harmonie,

Vault-Tec Corporation
"Construire un meilleur demain, aujourd’hui."`;
            const contentData = {
                citoyens: ``, // Sera géré dynamiquement
                superviseurH: `================================================================
  DOCUMENT CONFIDENTIEL – ACCÈS RESTREINT – NIVEAU OMEGA
================================================================
ORGANISATION : Vault-Tec Corporation, Dpt. Psychologie Appliquée
SECTION      : Abri 202 – Habitat
RÉF. DOSSIER : VT/202-H/Ω-15
----------------------------------------------------------------

[EN-TÊTE OFFICIEL]

    DESTINATAIRE : Superviseur, Section Habitat – Abri 202
    DE           : Bureau de la Cohésion Humaine, Vault-Tec
    OBJET        : Mandat et directives – Programme "Transition Numérique" (Projet Arche)
    CONFIDENTIALITÉ : **SUPERVISEUR UNIQUEMENT** – Transmission interdite.

Cher Superviseur,

Vous avez été choisi pour diriger la section HABITAT de l’Abri 202 dans le cadre d’une expérience cruciale : déterminer si l’humanité est prête à renoncer volontairement à la vie physique pour une existence numérique améliorée.

Le “Grand Choix” aura lieu dans plusieurs années. À ce moment-là, chaque citoyen décidera s’il préfère rester dans la réalité imparfaite… ou vivre pour toujours dans l’environnement parfait de L’Arche.

Votre rôle est de préparer ce choix — en créant un contraste si saisissant entre la dureté de la réalité et le confort de l’Arche que la majorité optera pour la transition numérique.

**RÉSUMÉ DE MISSION (VERSION OFFICIELLE)**
    1. Maintenir l’ordre, mais dans un contexte **volontairement oppressant** et difficile.
    2. Garantir que les habitants voient L’Arche comme un paradis enviable.
    3. Organiser des séjours de “découverte” (officiellement par tirage au sort).
    4. Coopérer avec le Superviseur Arche.
    5. **Ne jamais évoquer la nature simulée de l'Arche.**

**OBJECTIFS OPÉRATIONNELS**
    - Rendre la vie quotidienne exigeante et frustrante (limites de sécurité minimales).
    - Contrôler le flux d’informations pour préserver le secret.
    - Utiliser pénuries, contraintes et règlements pour créer un climat de tension.
    - Mettre en valeur l’Arche via propagande (récits, cérémonies, témoignages).
    - Maintenir la façade d’un leader “qui fait de son mieux” dans un monde difficile.

**CADRE DE CROYANCE (À PROTÉGER)**
    - L’inconfort actuel est un sacrifice nécessaire.
    - Les visiteurs de l’Arche y vivent une expérience réelle dans un lieu physique.
    - Les effets secondaires (fatigue, confusion) sont attribués au “dépaysement” et non à des causes neurologiques.

**DIRECTIVES COMPORTEMENTALES (RP)**
    - **Posture** : Figure d’autorité ferme mais “injustement accablée”.
    - **Méthode** : Appliquer des mesures dégradant la qualité de vie (rationnements, couvre-feu).
    - **Communication** : Insister sur le privilège de l’Arche et la dureté de la réalité.
    - **Mise en scène** : Faire du départ vers l’Arche un événement solennel, quasi religieux.


RAPPEL :
Votre mission est de façonner la perception. Le choix final doit paraître libre… mais il doit être, dans l’esprit de la majorité, une évidence.

Pour l’avenir de l’humanité,
Vault-Tec Corporation
"Construire un meilleur demain, aujourd’hui."`,

                superviseurA: `================================================================
  DOCUMENT CLASSIFIÉ – ACCÈS ULTRA-PRIORITÉ – LECTURE UNIQUE
================================================================
ORGANISATION : Vault-Tec Corporation, Dpt. R&D Expérimental
SECTION      : Abri 202 – Arche
RÉF. DOSSIER : VT/202-A/Δ-18
----------------------------------------------------------------

[EN-TÊTE OFFICIEL]

    DESTINATAIRE : Superviseur, Section Arche – Abri 202
    DE           : Direction des Opérations Spéciales, Vault-Tec
    OBJET        : Directive opérationnelle – Programme "Mutation Contrôlée"
    CONFIDENTIALITÉ : **ULTRA-PRIORITÉ** – Destruction après lecture recommandée.

Cher Superviseur,

Félicitations. Vous êtes le seul dépositaire de la vérité complète sur le projet Arche. Vous savez que l’Arche n’est pas un havre, mais un système d’expérimentation biologique reposant sur une simulation numérique immersive.

Votre rôle est double :
    - **Officiellement** : Gérer un sanctuaire où les citoyens séjournent.
    - **En réalité** : Sélectionner des sujets, les plonger en sommeil artificiel, les soumettre à des radiations et à des injections, puis les immerger dans la simulation que vous contrôlez. L’alternance entre le stress et l’oppression de la vie dans l’Habitat et celle dans l’Arche constitue un puissant accélérateur mutagène

**VÉRITÉ COMPLÈTE (POUR VOUS SEUL)**
    * **But Réel** : Provoquer, accélérer et observer des **mutations** physiques et mentales.
    * **Méthode** : Utiliser l'anxiété de l'Abri comme catalyseur biologique.
    * **Simulation** : Votre terrain de jeu pour pousser les sujets à leurs limites.
    * **Le Superviseur Habitat** : Votre pion. Il croit à un test philosophique (“le Grand Choix”). Maintenez cette illusion pour assurer sa coopération.

**OBJECTIFS RÉELS**
    1. **Sélection stratégique** : Choisir des candidats à potentiel génétique/psychologique.
    2. **Optimiser le catalyseur** : Encourager le Superviseur Habitat à durcir la vie dans l'Abri.
    3. **Expérimentation libre** : Concevoir des scénarios extrêmes dans la simulation.
    4. **Observation et documentation** : Noter les signes de mutation, ajuster les protocoles.
    5. **Maintien de la façade** : Garder le Superviseur Habitat dans sa croyance naïve.

**EXPLOITATION DU SUPERVISEUR HABITAT**
    - Il sait que l’Arche est une simulation.
    - Il croit que le but est le "Grand Choix" pour un paradis numérique.
    - Il croit que son rôle est de rendre la vie oppressive pour faciliter ce choix.
    - **Il ignore tout des manipulations biologiques.**

**STRATÉGIE DE MANIPULATION**
    - Encouragez le Superviseur Habitat à multiplier privations et tensions.
    - Feignez de partager son rêve du “Grand Choix” pour sa coopération totale.
    - Utilisez la simulation pour amplifier les effets biologiques sous couvert “d’expériences sociales”.


RAPPEL :
Vous êtes l’architecte de l’Arche. Les habitants ne doivent jamais comprendre qu’ils sont devenus les prototypes de la prochaine étape de l’humanité.

**MDP** du Superviseur H : choix

Pour l’avenir de l’espèce,
Vault-Tec Corporation
"Construire un meilleur demain, aujourd’hui."`,

                contexte: `============================================================
  PRÉSENTATION DU JDR – ABRI 202 : L’ARCHE
============================================================

**CONTEXTE GÉNÉRAL**

L’action se déroule dans l’univers post-apocalyptique de Fallout. Les bombes sont tombées. Votre groupe est confiné dans l’Abri 202, un complexe Vault-Tec présenté comme une prouesse d’ingénierie.

**RÔLES DES JOUEURS**

    **1. Superviseur Arche**
    - *Officiellement* : Gardien d’un sanctuaire luxueux, "L’Arche".
    - *En réalité* : Il plonge les habitants en sommeil artificiel, les expose à des radiations et injections, puis les enferme dans une simulation numérique pour provoquer et observer leur **mutation**.

    **2. Superviseur Habitat**
    - *Sa croyance* : Il teste si l’humanité est prête à abandonner la réalité pour un monde virtuel parfait (“Le Grand Choix”).
    - *Son rôle* : Rendre la vie quotidienne dure pour que L’Arche paraisse une délivrance.
    - *Son ignorance* : Il sait que l'Arche est une simulation, mais ignore tout des expériences biologiques.

    **3. Habitants**
    - Chaque joueur incarne un résident responsable d’une “aile” de l’Abri (1 PJ + 99 PNJ), regroupée par profil (sportifs, intellectuels, etc.).

**CE QUE CROIT LA POPULATION**

    - L’Abri 202 a deux sections : Habitat (vie) et Arche (paradis).
    - L’Arche est un lieu physique réel avec des animaux, séparé en deux zones (herbivores ici, carnivores dans un "Abri 404").
    - *La vérité* : L'Abri 404 n'existe pas. Le couloir vers l'Arche mène à une salle secrète où les sujets sont endormis et connectés.

**OBJECTIFS DES RÔLES**

    > **Superviseur Habitat** : Créer un climat oppressant, contrôler l'information, maintenir l'illusion d'une Arche physique.
    > **Superviseur Arche** : Manipuler le Superviseur Habitat, mener des expériences extrêmes dans la simulation.
    > **Habitants** : Survivre, comprendre la vérité, ou simplement profiter des opportunités.

**ACCÈS À L’ARCHE**

    - *Version officielle* : Tirage au sort mensuel, juste et transparent.
    - *En réalité* : Les deux superviseurs choisissent qui partira pour un séjour de deux jours... dans la simulation.`,

                mj: `<h3>Tableau d'Événements Aléatoires (d20)</h3><table style="width:100%; border-collapse: collapse; margin-bottom: 1em;" border="1"><thead><tr style="text-align: left;"><th style="padding: 5px;">d20</th><th style="padding: 5px;">Version Officielle</th><th style="padding: 5px;">Version Réelle</th><th style="padding: 5px;">Exploitation Superviseur</th></tr></thead><tbody><tr><td style="padding: 5px;">1</td><td style="padding: 5px;">Panne mineure d’eau chaude</td><td style="padding: 5px;">Test de privation pour observer le stress</td><td style="padding: 5px;">Rationne, provoque plaintes</td></tr><tr><td style="padding: 5px;">2</td><td style="padding: 5px;">Incident électrique dans une aile</td><td style="padding: 5px;">Coupure volontaire ciblée</td><td style="padding: 5px;">Isoler un groupe, créer tension</td></tr><tr><td style="padding: 5px;">3</td><td style="padding: 5px;">Animal “échappé” de l’Arche</td><td style="padding: 5px;">Faux incident pour propagande</td><td style="padding: 5px;">Fouilles, suspicion entre ailes</td></tr><tr><td style="padding: 5px;">4</td><td style="padding: 5px;">Fatigue collective inexpliquée</td><td style="padding: 5px;">Effets secondaires d’exposition</td><td style="padding: 5px;">Accuse mauvaise discipline</td></tr><tr><td style="padding: 5px;">5</td><td style="padding: 5px;">Mur fissuré dans l’aile agricole</td><td style="padding: 5px;">Sabotage interne orchestré</td><td style="padding: 5px;">Interrompt production, accuse négligence</td></tr><tr><td style="padding: 5px;">6</td><td style="padding: 5px;">Message radio brouillé reçu</td><td style="padding: 5px;">Faux signal contrôlé par Arche</td><td style="padding: 5px;">Augmente paranoïa</td></tr><tr><td style="padding: 5px;">7</td><td style="padding: 5px;">Feu mineur dans zone commune</td><td style="padding: 5px;">Mise en scène pour tester réactions</td><td style="padding: 5px;">Restreint accès à zones clés</td></tr><tr><td style="padding: 5px;">8</td><td style="padding: 5px;">Maladie bénigne</td><td style="padding: 5px;">Infection volontairement propagée</td><td style="padding: 5px;">Quarantaine stricte</td></tr><tr><td style="padding: 5px;">9</td><td style="padding: 5px;">Vol de rations</td><td style="padding: 5px;">Vol organisé par Habitat</td><td style="padding: 5px;">Punit collectivement</td></tr><tr><td style="padding: 5px;">10</td><td style="padding: 5px;">Apparition de graffitis anti-Vault-Tec</td><td style="padding: 5px;">Créés par agent provocateur</td><td style="padding: 5px;">Campagne de propagande</td></tr><tr><td style="padding: 5px;">11</td><td style="padding: 5px;">Panne de ventilation</td><td style="padding: 5px;">Scénario de stress respiratoire</td><td style="padding: 5px;">Imposer masque et restrictions</td></tr><tr><td style="padding: 5px;">12</td><td style="padding: 5px;">Tirage au sort spécial “enfants”</td><td style="padding: 5px;">Choix orienté par superviseurs</td><td style="padding: 5px;">Valorise familles dociles</td></tr><tr><td style="padding: 5px;">13</td><td style="padding: 5px;">Disparition d’un habitant</td><td style="padding: 5px;">Envoi secret vers Arche</td><td style="padding: 5px;">Rumeurs contrôlées</td></tr><tr><td style="padding: 5px;">14</td><td style="padding: 5px;">Fuite d’un “prisonnier”</td><td style="padding: 5px;">Faux détenu introduit</td><td style="padding: 5px;">Justifie couvre-feu</td></tr><tr><td style="padding: 5px;">15</td><td style="padding: 5px;">Objets “interdits” trouvés</td><td style="padding: 5px;">Pièges posés par Habitat</td><td style="padding: 5px;">Perquisitions, peur collective</td></tr><tr><td style="padding: 5px;">16</td><td style="padding: 5px;">Fête de la Lumière</td><td style="padding: 5px;">Cérémonie propagande</td><td style="padding: 5px;">Discours, chants obligatoires</td></tr><tr><td style="padding: 5px;">17</td><td style="padding: 5px;">Incident de cuisine (explosion)</td><td style="padding: 5px;">Acte volontaire</td><td style="padding: 5px;">Réduit qualité repas</td></tr><tr><td style="padding: 5px;">18</td><td style="padding: 5px;">Concours artistique “Hommage à l’Arche”</td><td style="padding: 5px;">Test de propagande</td><td style="padding: 5px;">Évaluer loyauté créative</td></tr><tr><td style="padding: 5px;">19</td><td style="padding: 5px;">Température glaciale soudaine</td><td style="padding: 5px;">Manipulation du climat interne</td><td style="padding: 5px;">Forcer regroupement</td></tr><tr><td style="padding: 5px;">20</td><td style="padding: 5px;">Nouvelle “loi” imposée</td><td style="padding: 5px;">Mesure arbitraire pour contrôle</td><td style="padding: 5px;">Tester obéissance</td></tr></tbody></table>
<br>
<h3>Plan de briefing MJ — Projet Arche</h3>
<h4>Phase 0: Pré-Session</h4>
<p><strong>Matériel à distribuer :</strong></p>
<ul><li><strong>Habitants :</strong> "Lettre de Bienvenue Officielle" (propagande).</li><li><strong>Superviseur Habitat :</strong> Dossier de mission "Transition Numérique".</li><li><strong>Superviseur Arche :</strong> Directive "Mutation Contrôlée".</li></ul>

<h4>Phase 1: Briefing Commun (Tous les joueurs)</h4>
<p><strong>Objectif :</strong> Établir la façade officielle.</p>
<p><strong>Narratif :</strong> Vous êtes dans l'Abri 202. Il y a la section Habitat (votre vie) et la section Arche (un paradis physique). Un tirage au sort mensuel récompense les bons citoyens par un séjour dans l'Arche.</p>
<p><strong>Action :</strong> Distribuer la lettre aux Habitants, puis les isoler temporairement.</p>

<h4>Phase 2: Briefing Sécurisé (Superviseurs Habitat & Arche)</h4>
<p><strong>Objectif :</strong> Révéler le niveau 1 de la vérité.</p>
<p><strong>Narratif :</strong> "La version publique est un mensonge. L'Arche est une simulation. Notre but est de tester si l'humanité choisirait un paradis numérique. Habitat, votre rôle est de rendre la réalité... difficile. Arche, votre rôle est de rendre la simulation... parfaite."</p>
<p><strong>Action :</strong> Isoler le Superviseur Habitat.</p>

<h4>Phase 3: Briefing Top-Secret (MJ & Superviseur Arche)</h4>
<p><strong>Objectif :</strong> Révéler la vérité ultime.</p>
<p><strong>Narratif :</strong> "La simulation n'est qu'un outil. Le but réel est l'expérimentation biologique. Vous sélectionnez les sujets, les endormez, les irradiez, et observez les mutations dans la simulation. Le Superviseur Habitat est votre instrument pour catalyser le processus. Ne le laissez jamais l'apprendre."</p>

<h4>Phase 4: Lancement du Jeu</h4>
<p><strong>Scénario d'ouverture :</strong> Déclencher une crise immédiate (ex: panne de ventilation, menace de suffocation) pour forcer les décisions.</p>
<p><strong>Règle clé :</strong> Le métagaming est interdit. L'information est votre ressource la plus précieuse.</p>`
            };

            // --- ÉTAT DE L'APPLICATION ---
            let currentTab = 'citoyens';
            let typingInterval = null;
            let targetTabAfterPassword = null;

            // --- FONCTIONS ---

            // Horloge temps réel
            function updateClock() {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString('fr-FR');
            }

            // Affiche le texte instantanément
            function typeWriter(text, onComplete = () => {}) {
                if (typingInterval) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                }
                // Remplacer les **...** par des balises <strong> pour le gras
                const htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                textContentElement.innerHTML = htmlText;
                cursorElement.style.display = 'none';
                textContentElement.parentElement.scrollTop = 0;
                onComplete();
            }

            // Affiche le texte instantanément
            function typeWriterWordByWord(text, onComplete = () => {}) {
                if (typingInterval) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                }
                textContentElement.innerHTML = text;
                cursorElement.style.display = 'none';
                textContentElement.parentElement.scrollTop = 0;
                onComplete();
            }

            // Afficher le contenu d'un onglet
            function displayTabContent(tabId) {
                currentTab = tabId;
                document.querySelectorAll('.nav-bar button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabId);
                });

                textContentElement.style.opacity = '0'; // On rend le contenu invisible

                setTimeout(() => {
                    if (tabId === 'citoyens') {
                        typeWriterWordByWord(welcomeLetter, () => {
                            const signatureArea = document.createElement('div');
                            signatureArea.style.textAlign = 'center';
                            signatureArea.style.marginTop = '20px';

                            const signButton = document.createElement('button');
                            signButton.textContent = 'Signer ici';
                            // Appliquer les styles des autres boutons pour la cohérence
                            signButton.style.fontFamily = 'inherit';
                            signButton.style.fontSize = '1rem';
                            signButton.style.padding = '8px 16px';
                            signButton.style.background = 'transparent';
                            signButton.style.border = '1px solid var(--primary-color)';
                            signButton.style.color = 'var(--primary-color)';
                            signButton.style.cursor = 'pointer';
                            signButton.style.textShadow = 'inherit';

                            signButton.addEventListener('mouseover', () => {
                               signButton.style.background = 'var(--primary-color)';
                               signButton.style.color = 'var(--color-black)';
                            });
                            signButton.addEventListener('mouseout', () => {
                               signButton.style.background = 'transparent';
                               signButton.style.color = 'var(--primary-color)';
                            });


                            const docInfo = document.createElement('p');
                            docInfo.textContent = 'Document Officiel – Diffusion Générale';
                            docInfo.style.marginTop = '10px';
                            docInfo.style.fontSize = '0.9rem';

                            signButton.addEventListener('click', () => {
                                textContentElement.style.opacity = '0';
                                setTimeout(() => {
                                    typeWriter(officialDocument, () => {
                                        // Créer et ajouter le bouton biométrique
                                        const biometricButton = document.createElement('button');
                                        biometricButton.textContent = 'Enregistrement Biométrique';
                                        biometricButton.className = 'biometric-button';

                                        biometricButton.addEventListener('click', async () => {
                                            playSound('audio-button');

                                            // Check character limit
                                            try {
                                                const response = await fetch('/.netlify/functions/get-characters');
                                                const characters = await response.json();

                                                if (response.ok && characters.length >= 7) {
                                                    showAlert(
                                                        "ACCÈS REFUSÉ",
                                                        "Le nombre maximum de 7 habitants pour cette expérience a été atteint. Aucun enregistrement supplémentaire n'est autorisé.",
                                                        true // isError = true
                                                    );
                                                } else {
                                                    initializeSpecialModal();
                                                    specialModalOverlay.classList.add('visible');
                                                }
                                            } catch (error) {
                                                showAlert("ERREUR SYSTÈME", `Impossible de vérifier la liste des citoyens. Erreur: ${error.message}`, true);
                                            }
                                        });

                                        textContentElement.appendChild(biometricButton);
                                    });
                                    textContentElement.style.opacity = '1';
                                }, 500);
                            });

                            signatureArea.appendChild(signButton);
                            signatureArea.appendChild(docInfo);
                            textContentElement.appendChild(signatureArea);
                        });
                    } else {
                        typeWriter(contentData[tabId]);
                    }
                    textContentElement.style.opacity = '1'; // On affiche le nouveau contenu en fondu
                }, 500); // On attend la fin de la transition
            }
            
            // Gérer le clic sur un onglet
            function handleNavClick(e) {
                const button = e.target.closest('button');
                if (!button || button.classList.contains('active')) return;

                triggerGlitchEffect(mainInterface);
                playSound('audio-button');

                const tabId = button.dataset.tab;
                const requiredPassword = button.dataset.password;

                setTimeout(() => {
                    if (requiredPassword) {
                        targetTabAfterPassword = tabId;
                        passwordInput.value = '';
                        passwordInput.classList.remove('error');
                        modal.classList.remove('shake');
                        modalOverlay.classList.add('visible');
                        passwordInput.focus();
                        playSound('audio-protected');
                    } else {
                        displayTabContent(tabId);
                    }
                }, 150);
            }
            
            // --- NUKA-COLA POPUP LOGIC ---
            let nukaAdShown = false;

            function showNukaAd() {
                if (!nukaAdShown) {
                    nukaPopupOverlay.classList.add('visible');
                    nukaAdShown = true;
                }
            }

            nukaCloseBtn.addEventListener('click', () => {
                nukaPopupOverlay.classList.remove('visible');
            });

            // Gérer la soumission du mot de passe
            function handlePasswordSubmit(e) {
                e.preventDefault();
                const enteredPassword = passwordInput.value;
                const requiredPassword = document.querySelector(`[data-tab="${targetTabAfterPassword}"]`).dataset.password;

                if (enteredPassword === requiredPassword) {
                    modalOverlay.classList.remove('visible');
                    displayTabContent(targetTabAfterPassword);
                    targetTabAfterPassword = null;
                    playSound('audio-mdp-ok');
                } else {
                    passwordInput.classList.add('error');
                    modal.classList.add('shake');
                    setTimeout(() => {
                        modal.classList.remove('shake');
                    }, 500);
                    playSound('audio-mdp-no');
                }
            }

            // --- LOGIQUE S.P.E.C.I.A.L. ---
            const specialDescriptionBox = document.getElementById('special-description-box');
            const characterLastnameInput = document.getElementById('character-lastname');
            const characterFirstnameInput = document.getElementById('character-firstname');
            let pointsToSpend = 21;

            const stats = {
                S: { name: 'Force', value: 1 },
                P: { name: 'Perception', value: 1 },
                E: { name: 'Endurance', value: 1 },
                C: { name: 'Charisme', value: 1 },
                I: { name: 'Intelligence', value: 1 },
                A: { name: 'Agilité', value: 1 },
                L: { name: 'Chance', value: 1 }
            };

            const specialDescriptions = {
                S: {
                    title: 'S — Strength (Force)',
                    description: 'Puissance physique et musculature.',
                    effects: 'Augmente les dégâts au corps à corps et à l’arme blanche. Permet de porter plus d’objets (capacité de charge). Certaines armes lourdes exigent un certain niveau de Force.',
                    example: 'Exemple : Un personnage avec 10 en Force peut trimballer un mini-gun et un frigo sans broncher… ou presque.'
                },
                P: {
                    title: 'P — Perception',
                    description: 'Sens de l’observation, vigilance, précision sensorielle.',
                    effects: 'Améliore la précision en V.A.T.S. Détecte plus facilement pièges, ennemis cachés, et emplacements d’objets. Certaines quêtes ou dialogues dépendent de ton acuité.',
                    example: 'Exemple : Repérer un ennemi bien avant qu’il te voie, ou trouver un passage secret.'
                },
                E: {
                    title: 'E — Endurance',
                    description: 'Résistance physique, santé générale.',
                    effects: 'Augmente les Points de Vie (HP). Réduit les dégâts des radiations et des poisons. Permet de courir plus longtemps ou d’encaisser plus de coups.',
                    example: 'Exemple : Survivre à une promenade dans une zone ultra-irradiée.'
                },
                C: {
                    title: 'C — Charisma (Charisme)',
                    description: 'Présence, force de persuasion, capacité à inspirer.',
                    effects: 'Ouvre des options de dialogue spéciales. Améliore le commerce (meilleurs prix). Dans certains Fallout (comme FO4), booste la gestion des colonies.',
                    example: 'Exemple : Convaincre un pillard armé jusqu’aux dents de te donner sa chemise… et un Stimpak.'
                },
                I: {
                    title: 'I — Intelligence',
                    description: 'Capacité de raisonnement, connaissance technique.',
                    effects: 'Plus de points de compétence par niveau (dans les jeux classiques). Débloque des options techniques dans les dialogues et interactions (hack, réparation). Influence la vitesse de progression dans certaines aptitudes.',
                    example: 'Exemple : Pirater un terminal de sécurité haut niveau sans te prendre un verrouillage permanent.'
                },
                A: {
                    title: 'A — Agility (Agilité)',
                    description: 'Coordination, vitesse, souplesse.',
                    effects: 'Plus de Points d’Action en V.A.T.S. Augmente la discrétion et la précision en combat. Permet de recharger plus vite ou de mieux viser en mouvement.',
                    example: 'Exemple : Te faufiler dans un camp ennemi sans qu’aucune alarme ne sonne.'
                },
                L: {
                    title: 'L — Luck (Chance)',
                    description: 'Ton petit coup de pouce du destin.',
                    effects: 'Augmente la fréquence des coups critiques. Influence les butins trouvés. Certains effets aléatoires deviennent beaucoup plus favorables.',
                    example: 'Exemple : Trouver un Fat Man avec 5 mini-bombes sur le premier ennemi croisé.'
                }
            };

            function initializeSpecialModal() {
                pointsToSpend = 21;
                Object.keys(stats).forEach(key => stats[key].value = 1);
                characterLastnameInput.value = '';
                characterFirstnameInput.value = '';
                specialDescriptionBox.innerHTML = '<p>Survolez un attribut pour lire sa description.</p>';
                renderSpecialStats();
            }

            function renderSpecialStats() {
                specialStatsContainer.innerHTML = '';
                pointsToSpendEl.textContent = pointsToSpend;

                for (const [key, stat] of Object.entries(stats)) {
                    const statEl = document.createElement('div');
                    statEl.className = 'stat';
                    statEl.dataset.statKey = key; // Ajout d'une data-attribute pour l'identification
                    statEl.innerHTML = `
                        <span class="stat-name">${key} (${stat.name})</span>
                        <div class="stat-controls">
                            <button data-stat="${key}" data-action="minus">-</button>
                            <span class="stat-value">${stat.value}</span>
                            <button data-stat="${key}" data-action="plus">+</button>
                        </div>
                    `;
                    specialStatsContainer.appendChild(statEl);
                }
            }

            specialStatsContainer.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;

                const statKey = button.dataset.stat;
                const action = button.dataset.action;

                if (action === 'plus' && pointsToSpend > 0 && stats[statKey].value < 10) {
                    stats[statKey].value++;
                    pointsToSpend--;
                } else if (action === 'minus' && stats[statKey].value > 1) {
                    stats[statKey].value--;
                    pointsToSpend++;
                }
                playSound('audio-key');
                renderSpecialStats();
            });

            specialStatsContainer.addEventListener('mouseover', e => {
                const statEl = e.target.closest('.stat');
                if (!statEl) return;

                const statKey = statEl.dataset.statKey;
                const info = specialDescriptions[statKey];

                if (info) {
                    specialDescriptionBox.innerHTML = `
                        <h4>${info.title}</h4>
                        <p><strong>Description :</strong> ${info.description}</p>
                        <p><strong>Effets principaux :</strong> ${info.effects}</p>
                        <p><em>${info.example}</em></p>
                    `;
                }
            });

            specialStatsContainer.addEventListener('mouseout', () => {
                // Optionnel : remettre le texte par défaut quand on quitte la zone des stats
                // specialDescriptionBox.innerHTML = '<p>Survolez un attribut pour lire sa description.</p>';
            });

            async function saveCharacterOnline(characterData) {
                const btn = document.getElementById('special-confirm-btn');
                btn.disabled = true;
                btn.textContent = 'Sauvegarde en cours...';

                try {
                    const response = await fetch('/.netlify/functions/save-character', {
                        method: 'POST',
                        body: JSON.stringify(characterData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        // Try to parse error response as JSON, but fall back to text
                        let errorMessage;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || `Erreur du serveur: ${response.status}`;
                        } else {
                            errorMessage = await response.text();
                        }
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    showAlert('SUCCÈS', result.message);

                    specialModalOverlay.classList.remove('visible');
                    playSound('audio-mdp-ok');

                    // Trigger mail notification
                    const mailBtn = document.getElementById('mail-btn');
                    mailBtn.classList.add('new-mail-notification');
                    setTimeout(() => {
                        mailBtn.classList.remove('new-mail-notification');
                    }, 10000); // Notification lasts for 10 seconds

                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    showAlert('ERREUR', `Échec de la sauvegarde en ligne. Erreur: ${error.message}\n\nLes données seront téléchargées localement comme solution de secours.`, true);
                    // Fallback to local download
                    saveCharacterToFile(characterData);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Valider la création';
                }
            }

            function saveCharacterToFile(characterData) {
                const dataStr = JSON.stringify(characterData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${characterData.nom.replace(/\s+/g, '_')}_character.json`;
                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }

            specialConfirmBtn.addEventListener('click', () => {
                const lastname = characterLastnameInput.value.trim();
                const firstname = characterFirstnameInput.value.trim();
                const password = document.getElementById('character-password').value;

                if (!lastname || !firstname) {
                    showAlert('ERREUR DE SAISIE', 'Veuillez renseigner le nom et les prénoms.', true);
                    return;
                }

                if (!password) {
                    showAlert('ERREUR DE SAISIE', 'Le mot de passe est obligatoire.', true);
                    return;
                }

                if (pointsToSpend > 0) {
                    showAlert('ATTENTION', 'Vous devez dépenser tous vos points S.P.E.C.I.A.L. !', true);
                    return;
                }

                const characterData = {
                    nom: lastname,
                    prenoms: firstname,
                    password: password, // This will be hashed server-side
                    special: stats
                };

                // Call the new online save function
                saveCharacterOnline(characterData);
            });

            specialCancelBtn.addEventListener('click', () => {
                playSound('audio-button');
                specialModalOverlay.classList.remove('visible');
            });


            // --- ALERTE MODALE PERSONNALISÉE ---
            function showAlert(title, message, isError = false) {
                alertModalTitle.textContent = title;
                alertModalBody.textContent = message;
                alertModalTitle.classList.toggle('error-title', isError);
                alertModalOverlay.classList.add('visible');
                playSound(isError ? 'audio-mdp-no' : 'audio-protected');
            }

            function showPrompt(title, body) {
                return new Promise((resolve) => {
                    promptModalTitle.textContent = title;
                    promptModalBody.textContent = body;
                    promptModalInput.value = '';
                    promptModalOverlay.classList.add('visible');
                    promptModalInput.focus();

                    const handleConfirm = (e) => {
                        e.preventDefault();
                        cleanup();
                        resolve(promptModalInput.value);
                    };

                    const handleCancel = () => {
                        cleanup();
                        resolve(null);
                    };

                    const cleanup = () => {
                        promptModalOverlay.classList.remove('visible');
                        promptForm.removeEventListener('submit', handleConfirm);
                        promptModalCancelBtn.removeEventListener('click', handleCancel);
                    };

                    promptForm.addEventListener('submit', handleConfirm);
                    promptModalCancelBtn.addEventListener('click', handleCancel);
                });
            }


            // --- LOGIQUE MESSAGERIE ---

            let loggedInCharacter = null;

            function showMailLogin() {
                loggedInCharacter = null;
                mailModal.innerHTML = `
                    <h2>Messagerie Privée</h2>
                    <form id="mail-login-form">
                        <input type="text" id="mail-login-name" placeholder="Nom du personnage..." required>
                        <input type="password" id="mail-login-password" placeholder="Mot de passe..." required>
                        <button type="submit">Connexion</button>
                        <button type="button" id="close-mail-modal-btn">Fermer</button>
                    </form>
                `;
            }

            function showInbox(character) {
                loggedInCharacter = character;
                let emailsHTML = '<p>Boîte de réception vide.</p>';
                if (character.emails && character.emails.length > 0) {
                    emailsHTML = character.emails.map(email => `
                        <div class="email-item">
                            <h4>De : ${email.from}</h4>
                            <p>${email.body}</p>
                        </div>
                    `).join('');
                }

                mailModal.innerHTML = `
                    <h2>Boîte de réception de ${character.prenoms} ${character.nom}</h2>
                    <div class="inbox-container">${emailsHTML}</div>
                    <button type="button" id="close-mail-modal-btn">Fermer</button>
                `;
            }


            // --- LOGIQUE CITOYENS ENREGISTRÉS ---

            function renderCitizensList(citizens) {
                citizensListContainer.innerHTML = ''; // Clear previous content
                if (citizens.length === 0) {
                    citizensListContainer.innerHTML = '<p>Aucun citoyen enregistré pour le moment.</p>';
                    return;
                }

                citizens.forEach(citizen => {
                    // Get all stats
                    const stats = Object.entries(citizen.special)
                        .map(([key, stat]) => `${key}:${stat.value}`)
                        .join(' | ');

                    const entry = document.createElement('div');
                    entry.className = 'citizen-entry';
                    entry.innerHTML = `
                        <div class="citizen-info">
                            <span class="citizen-name">${citizen.prenoms} ${citizen.nom}</span>
                            <span class="citizen-stats">Top Stats: ${stats}</span>
                        </div>
                        <button class="delete-citizen-btn" data-id="${citizen.id}">Supprimer</button>
                    `;
                    citizensListContainer.appendChild(entry);
                });
            }

            async function showRegisteredCitizens() {
                playSound('audio-button');
                citizensModalOverlay.classList.add('visible');
                citizensListContainer.innerHTML = '<p>Chargement...</p>';

                try {
                    const response = await fetch('/.netlify/functions/get-characters');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Erreur serveur');
                    }
                    const citizens = await response.json();
                    renderCitizensList(citizens);
                } catch (error) {
                    citizensListContainer.innerHTML = `<p style="color: var(--color-error);">Erreur: ${error.message}</p>`;
                }
            }


            // --- ÉCOUTEURS D'ÉVÉNEMENTS ---
            
            // Connexion initiale
            connectButton.addEventListener('click', () => {
                playSound('audio-connect');

                // Add glitch effect
                bootOverlay.classList.add('glitching');

                // After glitch, hide overlay and show main interface
                setTimeout(() => {
                    bootOverlay.classList.remove('glitching');
                    bootOverlay.classList.add('hidden');
                    mainInterface.classList.add('visible');
                    // Lancer le contenu du premier onglet
                    displayTabContent('citoyens');

                    // --- NUKA-COLA TRIGGER ---
                    setTimeout(() => {
                        if (Math.random() < 0.5) {
                            showNukaAd();
                        }
                    }, 5000); // 5-second delay

                }, 600); // Match animation duration
            });

            // Changement de thème
            themeSwitcher.addEventListener('click', () => {
                document.body.classList.toggle('theme-amber');
                playSound(document.body.classList.contains('theme-amber') ? 'audio-amber-on' : 'audio-amber-off');
            });
            
            // Navigation
            navBar.addEventListener('click', handleNavClick);
            registeredCitizensBtn.addEventListener('click', showRegisteredCitizens);
            mailBtn.addEventListener('click', () => {
                playSound('audio-button');
                mailModalOverlay.classList.add('visible');
                showMailLogin();
            });
            
            // Modal
            passwordForm.addEventListener('submit', handlePasswordSubmit);
            cancelBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('visible');
                targetTabAfterPassword = null;
            });
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('visible');
                    targetTabAfterPassword = null;
                }
            });
            closeCitizensModalBtn.addEventListener('click', () => {
                playSound('audio-button');
                citizensModalOverlay.classList.remove('visible');
            });

            alertModalCloseBtn.addEventListener('click', () => {
                alertModalOverlay.classList.remove('visible');
            });

            mailModalOverlay.addEventListener('click', (e) => {
                if (e.target === mailModalOverlay) {
                    mailModalOverlay.classList.remove('visible');
                }
            });

            mailModal.addEventListener('click', async (e) => {
                // Use delegation for buttons inside the dynamic content
                if (e.target.id === 'close-mail-modal-btn') {
                    playSound('audio-button');
                    mailModalOverlay.classList.remove('visible');
                }
            });

            mailModal.addEventListener('submit', async (e) => {
                if (e.target.id !== 'mail-login-form') return;
                e.preventDefault();

                const form = e.target;
                const nameInput = form.querySelector('#mail-login-name');
                const passwordInput = form.querySelector('#mail-login-password');
                const submitBtn = form.querySelector('button[type="submit"]');

                const nom = nameInput.value;
                const password = passwordInput.value;

                submitBtn.disabled = true;
                submitBtn.textContent = '...';

                try {
                    const response = await fetch('/.netlify/functions/login-character', {
                        method: 'POST',
                        body: JSON.stringify({ nom, password }),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Erreur inconnue.');
                    }

                    showInbox(result); // Show the inbox with the returned character data

                } catch (error) {
                    showAlert('ERREUR DE CONNEXION', error.message, true);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Connexion';
                }
            });

            citizensListContainer.addEventListener('click', async (e) => {
                if (!e.target.classList.contains('delete-citizen-btn')) return;

                playSound('audio-button');
                const btn = e.target;
                const characterId = btn.dataset.id;
                const password = await showPrompt('CONFIRMATION REQUISE', 'Veuillez entrer le mot de passe pour supprimer ce personnage :');

                if (password === null) return; // User cancelled the prompt
                if (!password) {
                    showAlert('ERREUR', 'Le mot de passe est requis pour la suppression.', true);
                    return;
                }

                btn.disabled = true;
                btn.textContent = '...';

                try {
                    const response = await fetch('/.netlify/functions/delete-character', {
                        method: 'POST',
                        body: JSON.stringify({ id: characterId, password: password }),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Erreur inconnue.');
                    }

                    showAlert('SUCCÈS', result.message);
                    await showRegisteredCitizens(); // Refresh the list

                } catch (error) {
                    showAlert('ERREUR', `Erreur lors de la suppression : ${error.message}`, true);
                    btn.disabled = false;
                    btn.textContent = 'Supprimer';
                }
            });


            // --- INITIALISATION ---
            setInterval(updateClock, 1000);
            updateClock();
        });
    </script>
</body>
</html>
